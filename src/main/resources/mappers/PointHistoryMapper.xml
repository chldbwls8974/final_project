<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.kh.final_project.dao.PointHistoryDAO">

	<insert id="insertPointHistory">
		insert into point_history(ph_price, ph_source, ph_me_num) 
			values(#{pointHistory.ph_price}, #{pointHistory.ph_source}, #{pointHistory.ph_me_num})
	</insert>
	<select id="selectPointRefundHistoryByUserNum" resultType="kr.kh.final_project.vo.PointHistoryVO">
		select 
			* 
		from 
			point_history 
		where 
			ph_me_num = #{user.me_num} and
			(ph_source = '4' or ph_source = '5')
        order by ph_num desc;
	</select>
	<delete id="deleteRefundPointHistory">
		delete from point_history
		where ph_num = ${pointHistory.ph_num};
	</delete>
	<select id="selectPointHistoryByNum" resultType="kr.kh.final_project.vo.PointHistoryVO">
		select 
			* 
		from 
			point_history 
		where 
			ph_num = #{ph_num}
	</select>
	<insert id="insertPointHistorySoloMatch">
		insert into point_history(ph_price, ph_source, ph_mt_num, ph_me_num)
		values
		(-#{point} * if(#{source} = 1, 1, (
				select
					case
						when
							now() > adddate(addtime(mt_date, ti_time), interval -90 minute)	then 0
						when
							now() >addtime(mt_date, '00:00:00') then 0.2
						when
							now() > adddate(mt_date, interval -1 day) then 0.8
						when
							adddate(mt_date, interval -1 day) > now() then 1
					end as per
				from
					`match`
						join
					time on mt_ti_num = ti_num
				where
					mt_num = #{mt_num}))
		, #{source}, #{mt_num}, #{me_num})
	</insert>
	<select id="selectPointHistoryApplicationMatch" resultType="kr.kh.final_project.vo.PointHistoryVO">
		select
			*
		from
			point_history
		where
			ph_mt_num = #{mt_num} and
			ph_me_num = #{me_num} and
		    ph_source = 1
		order by
			ph_num desc
		limit
			1;
	</select>
</mapper>