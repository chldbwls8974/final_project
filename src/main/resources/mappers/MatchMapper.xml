<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.kh.final_project.dao.MatchDAO">
	<select id="selectMatchListOfManager" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
            stadium.*,
            facility.*,
            region.*,
            `time`.*
		from
			`match`
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
				join
			`time` on mt_ti_num = ti_num
				left join
			manager on mn_mt_num = mt_num
				left join
			(select
                mt_ti_num as t1
			from
				manager
					join
				`match` on mn_mt_num = mt_num
			where
				mn_me_num = #{me_num} and
                mt_date = #{mt_date}) as T1 on T1.t1 = mt_ti_num
            	left join
			(select
                mt_ti_num + 1 as t2
			from
				manager
					join
				`match` on mn_mt_num = mt_num
			where
				mn_me_num = #{me_num} and
                mt_date = #{mt_date}) as T2 on T2.t2 = mt_ti_num
                left join
			(select
                mt_ti_num - 1 as t3
			from
				manager
					join
				`match` on mn_mt_num = mt_num
			where
				mn_me_num = #{me_num} and
                mt_date = #{mt_date}) as T3 on T3.t3 = mt_ti_num
		where
			mt_date = #{mt_date} and
            mt_state1 = 0 and
            if(ifnull(T1.t1, 0) + ifnull(T2.t2, 0) + ifnull(T3.t3, 0) + ifnull(mn_me_num, 0)= 0, true, false)
		order by
			ti_time asc;
	</select>
	<update id="updateMatchMtRuleTo0">
		update `match`
		set
			mt_rule = 0
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtRuleTo1">
		update `match`
		set
			mt_rule = 1
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtTypeTo0">
		update `match`
		set
			mt_Type = 0
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtTypeTo1">
		update `match`
		set
			mt_Type = 1
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtTypeTo2">
		update `match`
		set
			mt_Type = 2
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtState1To0">
		update `match`
		set
			mt_state1 = 0
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtState1To1">
		update `match`
		set
			mt_state1 = 1
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtState1To2">
		update `match`
		set
			mt_state1 = 2
		where
			mt_num = #{mt_num}
	</update>
	<update id="updateMatchMtState2To1">
		update `match`
		set
			mt_state2 = 1
		where
			mt_num = #{mt_num}
	</update>
	<select id="selectManagerMatchListByMtDate" resultType="kr.kh.final_project.vo.MatchVO">
		SELECT
			manager.*,
		    `match`.*,
		    time.*,
		    stadium.*,
		    facility.*,
		    region.*,
		    count(en_num) as entry_count,
		    if(now() >= addtime(addtime(mt_date, ti_time), "12:00:00"), 3,
			    if(now() >= addtime(mt_date, ti_time), 2,
		            if(mt_type = 1,
						if(now() >= addtime(addtime(mt_date, ti_time), "-01:30:00"), 1, 0),
						if(mt_type = 2,
							if(now() >= addtime(addtime(mt_date, ti_time), "-12:00:00"), 1, 0), 0)))) as ready
		FROM
			manager
				join
			`match` on mn_mt_num = mt_num
				join
			time on ti_num = mt_ti_num
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
				left join
			team on te_mt_num = mt_num
				left join
			entry on en_te_num = te_num
		where
			mt_date = #{mt_date} and
			mt_state1 = 0 and
			mn_me_num = #{me_num}
		group by
			mt_num
		order by
			ti_num asc
	</select>
	<select id="selectMatchListOfSolo" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
            stadium.*,
            facility.*,
            region.*,
            `time`.*,
            count(en_num) as entry_count,
            ifnull(T0.t0 = mt_num, 0) as application,
            if(ifnull(T1.t1, 0) + ifnull(T2.t2, 0) + ifnull(T3.t3, 0) = 0, true, false) as application_able,
            if(now() >= addtime(addtime(mt_date, ti_time), "-01:30:00"), 1, 0) as ready
		from
			`match`
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
				join
			`time` on mt_ti_num = ti_num
				left join
			team on te_mt_num = mt_num
				left join
			entry on en_te_num = te_num
            	left join
			(select
				mt_num as t0
			from
				entry
					join
				team on en_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				en_me_num = #{me_num} and
				mt_date = #{mt_date}) as T0 on T0.t0 = mt_num
				left join
			(select
				mt_ti_num as t1
			from
				entry
					join
				team on en_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				en_me_num = #{me_num} and
				mt_date = #{mt_date}) as T1 on T1.t1 = mt_ti_num
                left join
			(select
				mt_ti_num + 1 as t2
			from
				entry
					join
				team on en_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				en_me_num = #{me_num} and
				mt_date = #{mt_date}) as T2 on T2.t2 = mt_ti_num
                left join
			(select
				mt_ti_num - 1 as t3
			from
				entry
					join
				team on en_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				en_me_num = #{me_num} and
				mt_date = #{mt_date}) as T3 on T3.t3 = mt_ti_num
		where
			mt_date = #{mt_date} and
            mt_state1 = 0 and
            (mt_type = 0 or mt_type = 1) and
            ti_time >= if(mt_date = date(now()), time(now()), '00:00:00')
		group by
			mt_num
		order by
			ti_time asc;
	</select>
	<select id="selectMatchByMeNum" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
			stadium.*,
			facility.*,
			region.*,
			`time`.*,
			count(en_num) as entry_count,
			count(e1) as entry_res,
            if(now() >= addtime(addtime(mt_date, ti_time), "-01:30:00"), 1, 0) as ready
		from
			`match`
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
				join
			`time` on mt_ti_num = ti_num
				left join
			team on te_mt_num = mt_num
				left join
			entry on en_te_num = te_num
				left join
			(select
				en_me_num as e1
			from
				entry
					join
				team on en_te_num = te_num
			where
				en_me_num = #{me_num} and
				te_mt_num = #{mt_num} and
				te_type = 0) as E1 on E1.e1 = en_me_num
		where
			mt_num = #{mt_num}
		group by
			mt_num
		order by
			ti_num asc
	</select>
	<select id="selectMatchListOfClub" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
            stadium.*,
            facility.*,
            region.*,
            `time`.*,
            count(en_num) as entry_count,
            count(e1) as club_entry_count,
            ifnull(team_count, 0) as team_count,
            ifnull(T0.t0 = mt_num, 0) as application,
            if(ifnull(T1.t1, 0) + ifnull(T2.t2, 0) + ifnull(T3.t3, 0) = 0, true, false) as application_able,
            if(now() >= addtime(addtime(mt_date, ti_time), "-12:00:00"), 1, 0) as ready
		from
			`match`
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
				join
			`time` on mt_ti_num = ti_num
				join
			(select
				tt_ti_num as ti
			from
				club
					join
				team_preferred_time on tt_cl_num = cl_num
			where
				cl_num = #{cl_num}) as Ti on Ti.ti = ti_num
				left join
			team on te_mt_num = mt_num
				left join
			club_team on ct_te_num = te_num
				left join
			entry on en_te_num = te_num
				left join
			(select
				en_num as e1
			from
				entry
					join
				team on en_te_num = te_num
					join
				club_team on ct_te_num = te_num
			where
				ct_cl_num = #{cl_num}) as E1 on E1.e1 = en_num
                left join
                (select
				mt_num as t0
			from
				club_team
					join
				team on ct_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				ct_cl_num = #{cl_num} and
				mt_date = #{mt_date}) as T0 on T0.t0 = mt_num
				left join
			(select
				mt_ti_num as t1
			from
				club_team
					join
				team on ct_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				ct_cl_num = #{cl_num} and
				mt_date = #{mt_date}) as T1 on T1.t1 = mt_ti_num
                left join
			(select
				mt_ti_num + 1 as t2
			from
				club_team
					join
				team on ct_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				ct_cl_num = #{cl_num} and
				mt_date = #{mt_date}) as T2 on T2.t2 = mt_ti_num
                left join
			(select
				mt_ti_num - 1 as t3
			from
				club_team
					join
				team on ct_te_num = te_num
					join
				`match` on te_mt_num = mt_num
			where
				ct_cl_num = #{cl_num} and
				mt_date = #{mt_date}) as T3 on T3.t3 = mt_ti_num
				left join
			(select
				mt_num as mt,
				count(te_num) as team_count
			from
				`match`
					join
				team on te_mt_num = mt_num
			where
				mt_date = #{mt_date} and
				te_type != 0
			group by
				mt_num) as TC on TC.mt = mt_num
		where
			mt_date = #{mt_date} and
            mt_state1 = 0 and
            (mt_type = 0 or mt_type = 2) and
            ti_time >= if(mt_date = date(now()), time(now()), '00:00:00')
		group by
			mt_num
		order by
			ti_time asc;
	</select>
	<select id="selectMatchByClNum" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
			stadium.*,
			facility.*,
			region.*,
			`time`.*,
			count(en_num) as entry_count,
			count(e1) as club_entry_count,
			(select
				count(te_num) as team_count
			from
				`match`
					join
				team on te_mt_num = mt_num
			where
				mt_num = #{mt_num} and
				te_type != 0) as team_count,
			if(count(t1) = 0, 0, 1) as entry_res,
            if(now() >= addtime(addtime(mt_date, ti_time), "-12:00:00"), 1, 0) as ready
		from
			`match`
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
				join
			`time` on mt_ti_num = ti_num
				left join
			team on te_mt_num = mt_num
				left join
			club_team on ct_te_num = te_num
				left join
			entry on en_te_num = te_num
				left join
			(select
				en_num as e1
			from
				entry
					join
				team on en_te_num = te_num
					join
				club_team on ct_te_num = te_num
			where
				ct_cl_num = #{cl_num}) as E1 on E1.e1 = en_num
				left join
			(select
				te_num as t1
			from
				team
					join
				club_team on ct_te_num = te_num
			where
				te_mt_num = #{mt_num} and
				ct_cl_num = #{cl_num} and
				te_type != 0) as T1 on T1.t1 = te_num
		where
			mt_num = #{mt_num}
		group by
			mt_num
		order by
			ti_num asc;
	</select>
	<delete id="deleteMatch">
		delete
			`match`
		from
			`match`
				join
			time on mt_ti_num = ti_num
		where
			now() >= addtime(addtime(mt_date, ti_time), "-01:30:00") and
			mt_state2 = 0;
	</delete>
	<select id="selectLimitMatch" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
			time.*
		from
			`match`
				join
			time on mt_ti_num = ti_num
		where
			now() >= addtime(addtime(mt_date, ti_time), "-01:30:00") and
		    mt_type = 0
		group by
			mt_num
	</select>
	<select id="selectMatchSolo" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
			time.*,
			mt_personnel * if(mt_rule = 0, 2, if(mt_rule = 1, 3, 0)) > count(en_num) as `delete`
		from
			`match`
				join
			time on mt_ti_num = ti_num
				left join
			team on te_mt_num = mt_num
				left join
			entry on en_te_num = te_num
		where
			now() >= addtime(addtime(mt_date, ti_time), "-01:30:00") and
			mt_type = 1
		group by
			mt_num
	</select>
	<select id="selectMatchClub" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
			time.*,
			if(mt_rule = 0, 2, if(mt_rule = 1, 3, 0)) > count(te_num) as `delete`
		from
			`match`
				join
			time on mt_ti_num = ti_num
				left join
			team on te_mt_num = mt_num
		where
			now() >= addtime(addtime(mt_date, ti_time), "-12:00:00") and
		    te_type != 0 and
			mt_type = 2
		group by
			mt_num
	</select>
	<select id="selectEndMatch" resultType="kr.kh.final_project.vo.MatchVO">
		select
			`match`.*,
			time.*
		from
			`match`
				join
			time on mt_ti_num = ti_num
		where
			now() >= addtime(addtime(mt_date, ti_time), "12:00:00") and
    		mt_state1 = 0
		group by
			mt_num
	</select>
	<select id="selectManageMatchByMtNum" resultType="kr.kh.final_project.vo.MatchVO">
		SELECT
			manager.*,
			`match`.*,
			time.*,
			stadium.*,
			facility.*,
			region.*,
			count(t1.te_num) as team_count,
            ifnull(t2.te_type, 1) as list_team,
            (select
				count(qu_num)
			from
				`quarter`
			where
				qu_mt_num = #{mt_num}) as quarter_count,
			if(now() >= addtime(addtime(mt_date, ti_time), "12:00:00"), 3,
				if(now() >= addtime(mt_date, ti_time), 2,
					if(mt_type = 1,
						if(now() >= addtime(addtime(mt_date, ti_time), "-01:30:00"), 1, 0),
						if(mt_type = 2,
							if(now() >= addtime(addtime(mt_date, ti_time), "-12:00:00"), 1, 0), 0)))) as ready
		FROM
			manager
				join
			`match` on mn_mt_num = mt_num
				left join
			(select * from team where te_type != 0) as t1 on t1.te_mt_num = mt_num
            	left join
			(select * from team where te_type = 0) as t2 on t2.te_mt_num = mt_num
				join
			time on ti_num = mt_ti_num
				join
			stadium on mt_st_num = st_num
				join
			facility on st_fa_num = fa_num
				join
			region on fa_rg_num = rg_num
		where
			mt_num = #{mt_num} and
			mt_state1 = 0
		group by
			mt_num
	</select>
</mapper>